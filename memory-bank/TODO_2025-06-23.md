# analyst-droid-one – TODO / Improvement Plan
_Date created: **2025-06-23**_

This file captures today’s full-stack audit plus a concrete, prioritised improvement roadmap. All open items are classified by theme with ✓/⚠️/🚫 reflecting current gaps.

---

## 0. Snapshot – What’s working (✓)
* FastAPI + Next 14 stack runs end-to-end; >30 integration tests pass.
* Conversation persistence (Alembic 003) operational.
* Metrics (`/metrics`) + Sentry wired.
* Graph-Aware RAG service, multi-LLM/Gemini integration, CrewAI tooling.
* Tools for GNN, whale-tracking, anomaly detection all present.

## 1. Observability & Ops
| Priority | Task |
|----------|------|
| P0 | Wire OpenTelemetry (FastAPI & Python stdlib) → OTLP → Grafana Tempo |
| P0 | Create Grafana dashboards: API p99 latency, provider spend, queue depth |
| P1 | Replace brute-force vector search with Redis 7 `HNSW` index + `FT.SEARCH` |
| P1 | Add Prometheus alert rules for 90 % budget, circuit OPEN state |
| P2 | Ensure metrics env vars templated in `docker-compose*.yml` |

## 2. Back-Pressure & Cost Control
* ✓ **BackpressureMiddleware mounted** in `backend/main.py` *(done 2025-06-23)*.
* Populate `providers/registry.yaml` with `budget`, `rate_limits`, `cost_rules`.
* Emit `external_api_credit_used_total` from Gemini & e2b clients.
* Write emergency budget protection unit test.

## 3. Security Hardening
1. Migrate to secure access/refresh cookies; rotate refresh tokens; enable blacklist.
2. Add SlowAPI rate-limit middleware to critical endpoints.
3. Review CORS: derive allowed origins from `.env` not hardcoded.

## 4. Scalability & Jobs
| Task | Notes |
|------|-------|
| Introduce Celery + Redis (or FastAPI Workers) | offload image/GNN heavy tools, SIM graph job |
| Convert `sim_graph_job` & code-gen tasks to background queue |
| Healthcheck for worker heartbeat + Prom metrics |

## 5. Graph Roadmap
* Finish **Explain-with-Cypher**: intercept generated Cypher, store in EvidenceBundle.
* Implement Graph Ideas backlog:
  * DeFi Protocol Map (Idea #2)
  * Token Ecosystem Network (Idea #4)
* Add Redis path-cache for common wallet pairs.

## 6. Developer Experience
* Pre-commit for `frontend` (eslint + type-check).
* Auto-generate typed OpenAPI client for React Query.
* Playwright e2e: login → chat → graph flow; add to CI matrix.
* Remove dead in-memory convo store comments in `chat.py`.

## 7. Deployment / DevOps
* Produce Helm chart (backend, frontend, PG, Neo4j, Redis).
* Add GitHub Actions `deploy.yaml` gated on main.
* Kustomize overlays for prod/staging.

## 8. Quick Wins (within 1 day)
- [x] Swap brute-force vector loop to Redis vector search – implemented via Redis **Vector Search HNSW** index (commit `eb6d80d`).
- [x] Mount `BackpressureMiddleware` – middleware now active for all routes (see same commit).
- [ ] Update `Next.js` Dockerfile `NODE_ENV=production`.
- [ ] Rename `DEBUG` env in compose to `FASTAPI_DEBUG` to avoid accidental prod debug.

## 9. Next Steps
1. Confirm backlog & priorities with stakeholders.
2. Create `phase-4` branch; scaffold Celery & OTEL.
3. Spin up staging via `docker-compose.prod.yml` + Prom/Grafana for baseline.
4. Break each section into GitHub issues & assign v1.9.0-beta / v2.0.0.

---
_Responsible: Daniel Thorp • Generated by Factory Droid on 2025-06-23_.
