# HITL Pause/Resume Workflow  
_Compliance Checker — Design Document_  

## 1 · Overview  

Regulators require a human analyst to approve or reject any potentially sensitive output generated by the `compliance_checker` agent. When the agent detects that manual approval is needed it **pauses** the running Crew, triggers a **webhook notification**, and awaits a **resume** call that carries the human decision.  
Goals:  

* Guarantee deterministic pause before sensitive content is released  
* Provide auditable record of every review & decision  
* Resume seamlessly on approval; abort cleanly on rejection  
* Work for both synchronous and background (async) crew runs  

---

## 2 · Architecture  

```
┌────────────┐           Pause req.           ┌────────────┐
│ compliance │── internal event (Pydantic) ─▶ │ CrewFactory│
│  checker   │                               │   (core)   │
└────────────┘                               └────┬───────┘
                                                 │
                                store task_state │  (PAUSED)
                                                 ▼
                                         ┌────────────┐
                                         │  API /crew │◄┐ resume/ status
                                         └────┬───────┘ │
                                              │         │
                            Background task ───┘         │
                                              │ notify   │
                                         ┌────▼───────┐  │
                                         │ Webhooks   │──┘
                                         └────┬───────┘
                                              │ HTTPS POST
                                    ┌─────────▼──────────┐
                                    │ External reviewer  │
                                    │  (Slack/Email/UI)  │
                                    └─────────▲──────────┘
                                              │ callback
                        /webhooks/callback ◄──┘
```

Key runtime stores (in-memory first, Redis later):  

| Store | Purpose | Lifetime |
|-------|---------|----------|
| `task_states` | per-crew execution state incl. PAUSED | until completion |
| `compliance_reviews` | review metadata & responses |  retention ≥ 90 d |
| `webhook_deliveries` | every outbound attempt & result | 30 d |

---

## 3 · REST API (FastAPI v1)  

| Verb | Path | Description | Auth |
|------|------|-------------|------|
| POST | `/api/v1/crew/run` | Kick-off crew, optional `async_execution` | JWT |
| GET  | `/api/v1/crew/status/{task_id}` | Poll task state | JWT |
| POST | `/api/v1/crew/pause/{task_id}` | (internal) invoked by agent to register review request | SERVICE TOKEN |
| POST | `/api/v1/crew/resume/{task_id}` | Human decision `{status: approved|rejected}` | JWT |
| GET  | `/api/v1/crew/review/{task_id}` | Fetch review metadata & history | JWT |

Task state enum: `PENDING | RUNNING | PAUSED | COMPLETED | FAILED`.

Resume payload (`ResumeRequest`):  

```json
{
  "status": "approved",
  "reviewer": "alice@example.com",
  "comments": "Looks good, proceed"
}
```

---

## 4 · Webhook Notification System  

### Registration  
`POST /api/v1/webhooks/register` → returns `webhook_id`. Supports **custom_url**, **slack**, **email**, **teams**.

### Delivery  
* Background task `_send_webhook` with retry (3 attempts, exponential back-off).  
* Signature header `X-Webhook-Signature` (HMAC-SHA256 over body with shared secret).  
* Payload type `ComplianceReviewPayload` contains:  
  * `event_type="compliance_review"`  
  * `task_id`, `review_id`, finding summary, risk level, expiry.

### Callback  
External system calls `POST /api/v1/webhooks/callback/{review_id}` (or Slack button URL) which internally triggers `/crew/resume`.

All deliveries recorded in `webhook_deliveries` with status `PENDING|DELIVERED|FAILED|RETRYING`.

---

## 5 · CrewAI Integration  

1. `compliance_checker` agent logic detects review need → raises `HITLPause` (custom) or returns special tool call.  
2. CrewFactory intercepts, calls `pause_crew()` which:  
   * sets `task_states[task_id].state = PAUSED`  
   * creates `compliance_reviews[review_id]`  
   * fires webhook(s).  
3. Upstream `/crew/run` returns `status: paused` to UI so it can show “Waiting for reviewer”.  
4. On approval the `/crew/resume` endpoint pushes result back into task inputs and background task `_resume_crew_in_background` continues the crew from the next task.  
5. If rejected, state moves to `FAILED` and error propagates.

---

## 6 · Example Scenarios  

### A. Happy Path (async)  
1. Analyst submits case → task `T123` starts async.  
2. At step 4 the compliance_checker pauses:  
   `task_states[T123].state = PAUSED`, review_id `REV-9F1A3B`.  
3. Slack message appears. Reviewer clicks **Approve**.  
4. Callback → `/crew/resume/T123` with status=approved.  
5. Background resume executes report_writer → `COMPLETED`.  

### B. Rejection  
Same as above but reviewer clicks **Reject** with comment.  
`task_states[T123].state = FAILED`, error stored, webhook “rejected” notification sent.

### C. Timeout / Expiry  
If no response before `expires_at`, periodic job marks review `EXPIRED`, task set to `FAILED`, alert emitted.

---

## 7 · Configuration  

| Env Var | Default | Description |
|---------|---------|-------------|
| `HITL_ENABLED` | `true` | Toggle entire feature |
| `WEBHOOK_TIMEOUT_SECONDS` | `10` | HTTP timeout per call |
| `MAX_RETRY_ATTEMPTS` | `3` | Delivery retries |
| `RETRY_DELAY_SECONDS` | `5` | Back-off base seconds |
| `DEFAULT_REVIEW_EXPIRY_MINUTES` | `60` | SLA for decision |
| `REQUIRE_NEO4J` | `true` | Already used for CI/service |

Webhooks persisted to YAML/DB so they survive restarts.

---

## 8 · Security Considerations  

* **Authentication**:  
  * All new endpoints require valid JWT except internal `/crew/pause` (protected by internal service token).  
* **Integrity**: HMAC signature on outbound webhook + timestamp headers.  
* **Least privilege**: Reviewer endpoints expose only review-related data.  
* **Replay protection**: `event_id` + signature +‐ time window verification possible.  
* **PII handling**: Payloads contain only derived findings, never raw customer data.  
* **Audit trail**: Review responses, comments, and webhook delivery logs retained ≥ 90 d and can be exported.  
* **Denial-of-Service**: Rate limiter on `/resume`, exponential retry on outbound to avoid flooding.  
* **Secrets management**: Webhook secrets and JWT keys managed via Kubernetes / Docker secrets.  

---

### Status & Next Steps  

* Core FastAPI endpoints & webhooks implemented in code (`backend/api/v1/crew.py`, `webhooks.py`).  
* Redis persistence + periodic expiry worker planned Phase-2.  
* Front-end Reviewer UI to display paused tasks and allow approve/reject is P2.  
